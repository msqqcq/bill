<!DOCTYPE html>
<html>
<head>
    <title>表单</title>
    <style>
        /* 在这里编写您的CSS样式 */
        #toggleIcon {
            transition: transform 0.3s ease;
        }

        #toggleBtn.expanded #toggleIcon {
            transform: rotate(90deg);
        }

        select {
            width: 100px;
            height: 21px;
        }

        input {
            width: 93px;
        }

        .choose_date {
            width: 110px;
        }

        table, th, td {
            text-align: center;
        }

        table.border {
            border-collapse: collapse; /* 合并单元格边框 */
            border: 1px solid black; /* 设置表格整体边框样式 */
        }

        table.border th, table.border td {
            border: 1px solid black; /* 设置表格整体边框样式 */
        }

    </style>
</head>
<body>

<h1>售卖信息</h1>
<!--<button onclick="toggleDiv('saleDiv', 'saleToggleBtn', 'saleToggleIcon')" id="saleToggleBtn">-->
<!--    统计销售<span id="saleToggleIcon">></span>-->
<!--</button>-->
<div id="saleDiv" style="display: block">
    <label for="choose_dpm_name"> 选择门店: </label>
    <select name="department[]" id="choose_dpm_name" class="department"></select>
    <label for="choose_sale_date">选择日期: </label>
    <input type="date" id="choose_sale_date" name="choose_sale_date" class="choose_date">

    <form id="addSaleForm">
        <table id="dataTable">
            <thead>
            <tr>
                <th>产品名称</th>
                <th>价格</th>
                <th>数量</th>
                <th>备注</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <button type="button" id="clearSaleButton">清空</button>
        <button type="submit">提交</button>
    </form>
</div>


<h1>预览</h1>

<!--<button onclick="toggleDiv('checkSaleDiv', 'checkSaleToggleBtn', 'checkSaleToggleIcon')" id="checkSaleToggleBtn">-->
<!--    预览数据<span id="checkSaleToggleIcon">></span>-->
<!--</button>-->
<div id="checkSaleDiv" style="display: block">
    <label for="choose_dpm_name_for_del"> 选择门店(可不选): </label>
    <select name="department[]" id="choose_dpm_name_for_check" class="department"></select>
    <label for="choose_sale_date_for_del">选择日期: </label>
    <input type="date" id="choose_sale_date_for_check" name="choose_sale_date_for_check" class="choose_date">
    <button type="button" id="checkSaleBtn">检查</button>

    <table id="checkTable" class="border">
        <thead>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>


<br>

<button onclick="toggleDiv('delSaleDiv', 'delSaleToggleBtn', 'delSaleToggleIcon')" id="delSaleToggleBtn">
    删除销售数据<span id="delSaleToggleIcon">></span>
</button>
<div id="delSaleDiv" style="display: none">
    <label for="choose_dpm_name_for_del"> 选择门店: </label>
    <select name="department[]" id="choose_dpm_name_for_del" class="department"></select>
    <label for="choose_sale_date_for_del">选择日期: </label>
    <input type="date" id="choose_sale_date_for_del" name="choose_sale_date_for_del" class="choose_date">
    <button type="button" id="delSaleBtn">删除</button>
</div>

<br><br>
<button onclick="toggleDiv('downloadDiv', 'downloadToggleBtn', 'downloadToggleIcon')" id="downloadToggleBtn">
    财务报表<span id="downloadToggleIcon">></span>
</button>
<div id="downloadDiv" style="display: none">
    <label for="choose_sale_date_for_download">选择日期: </label>
    <input type="date" id="choose_sale_date_for_download" name="choose_sale_date_for_download" class="choose_date">
    <button type="button" id="downloadTotalBtn" onclick="downloadTotalExcel()">下载总表</button>
    <br>
    <label for="choose_dpm_name_for_download"> 选择门店: </label>
    <select name="department[]" id="choose_dpm_name_for_download" class="department"></select>
    <button type="button" id="downloadSubBtn" onclick="downloadSubExcel()">下载分表</button>
    <button type="button" id="downloadAllSubBtn" onclick="downloadAllSubExcel()">下载全部分表</button>
</div>

<H1>门店信息</H1>
<button onclick="toggleDiv('dpmDiv', 'dpmToggleBtn', 'dpmToggleIcon')" id="dpmToggleBtn">
    修改门店信息<span id="dpmToggleIcon">></span>
</button>
<div id="dpmDiv" style="display: none">
    <label for="add_dpm_name"> 添加门店: </label>
    <input type="text" id="add_dpm_name" name="add_dpm_name">
    <button type="button" id="addDpmBtn">添加</button>
    <br>
    <label for="del_dpm_name"> 删除门店: </label>
    <select name="department[]" id="del_dpm_name" class="department"></select>
    <button type="button" id="delDpmBtn">删除</button>
</div>


<H1>产品信息</H1>
<button onclick="toggleDiv('productDiv', 'productToggleBtn', 'productToggleIcon')" id="productToggleBtn">
    修改产品信息<span id="productToggleIcon">></span>
</button>
<div id="productDiv" style="display: none">
    <label for="add_product_name"> 添加产品: </label>
    <input type="text" id="add_product_name" name="add_product_name" placeholder="名称">
    <input type="number" id="add_product_price" name="add_product_price" placeholder="价格">
    <button type="button" id="addProductBtn">添加</button>
    <br>
    <label for="update_product_name"> 修改产品: </label>
    <select name="product[]" id="update_product_name" class="product"></select>
    <input type="number" id="update_product_price" name="update_product_price" placeholder="价格">
    <button type="button" id="updateProductBtn">修改</button>
    <br>
    <label for="del_product_name"> 删除产品: </label>
    <select name="product[]" id="del_product_name" class="product"></select>
    <input type="number" id="del_product_price" name="del_product_price" placeholder="价格" readonly>
    <button type="button" id="delProductBtn">删除</button>
</div>

<script>
    let globalProducts = {};
    let globalSales = {}
    productPriceListening();
    defualtToday(['choose_sale_date', 'choose_sale_date_for_del', 'choose_sale_date_for_check', 'choose_sale_date_for_download']);
    // 获取标题选项列表并填充下拉框
    fetchOptions('http://localhost:6060/list/dpm', '.department');
    fetchOptions('http://localhost:6060/list/product', '.product');
    salesListening();

    const addDpmBtn = document.getElementById('addDpmBtn');
    const delDpmBtn = document.getElementById('delDpmBtn');

    const addProductBtn = document.getElementById('addProductBtn');
    const updateProductBtn = document.getElementById('updateProductBtn');
    const delProductBtn = document.getElementById('delProductBtn');
    const delSaleBtn = document.getElementById('delSaleBtn');
    const checkSaleBtn = document.getElementById('checkSaleBtn');

    addDpmBtn.addEventListener('click', function () {
        const dpm_name = document.getElementById("add_dpm_name").value.trim();
        if (dpm_name === "") {
            alert("请输入值");
            return;
        } else {
            fetch('http://localhost:6060/add/dpm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify([dpm_name])
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        }
    })

    delDpmBtn.addEventListener('click', function () {
        const dpm_name = document.getElementById("del_dpm_name").value.trim();
        if (dpm_name === "" || dpm_name === "NA") {
            alert("请选择一个值");
            return;
        } else {
            fetch('http://localhost:6060/rm/dpm/' + dpm_name, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        }
    })

    addProductBtn.addEventListener('click', function () {
        const product_name = document.getElementById("add_product_name").value.trim();
        const product_price = document.getElementById("add_product_price").value.trim();
        if (product_name && product_price) {
            fetch('http://localhost:6060/add/product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'name': product_name, 'price': product_price})
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        } else {
            alert("请输入值");
        }
    })

    updateProductBtn.addEventListener('click', function () {
        const product_name = document.getElementById("update_product_name").value.trim();
        const product_price = document.getElementById("update_product_price").value.trim();
        if (product_name && product_price) {
            fetch('http://localhost:6060/update/product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'name': product_name, 'price': product_price})
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        } else {
            alert("请输入值");
        }
    })

    delProductBtn.addEventListener('click', function () {
        const product_name = document.getElementById("del_product_name").value.trim();
        if (product_name && product_name !== "NA") {
            fetch('http://localhost:6060/rm/product/' + product_name, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        } else {
            alert("请输入值");
        }
    })

    delSaleBtn.addEventListener('click', function () {
        const date = document.getElementById('choose_sale_date_for_del').value.trim();
        const dpm = document.getElementById('choose_dpm_name_for_del').value.trim();
        if (date) {
            let yes = false;
            let dpms = []
            if (dpm && dpm !== 'NA') {
                yes = confirm("这将删除" + dpm + "在" + date + "全部的数据，确定删除吗？");
                dpms.push(dpm);
            } else {
                yes = confirm("这将删除" + date + "全部的数据，确定删除吗？");
            }

            if (yes) {
                fetch('http://localhost:6060/rm/sale/' + date, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dpms)
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            return Promise.reject(response);
                        }
                    })
                    .then(handleResult)
                    .catch(handleError);
            }
        } else {
            alert("请选择日期");
        }
    })

    checkSaleBtn.addEventListener('click', function () {
        const date = document.getElementById('choose_sale_date_for_check').value.trim();
        let dpm = document.getElementById('choose_dpm_name_for_check').value.trim();
        if (date) {
            let dpmt = 'NA';
            if (dpm) {
                dpmt = dpm;
            }
            fetch('http://localhost:6060/check/sale/' + date + '/' + dpmt, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(data => {
                    createCheckTable(data.data);
                })
                .catch(handleError);

        } else {
            alert("请选择日期");
        }
    })
    checkSaleBtn.click();

    const form = document.getElementById('addSaleForm');

    form.addEventListener('submit', function (event) {
        event.preventDefault();

        const date = document.getElementById('choose_sale_date').value.trim();
        const dpm = document.getElementById('choose_dpm_name').value.trim();

        if (date && dpm) {
            // 获取表单数据
            // const formData = new FormData(form);

            // 构建请求体
            const data = [];
            for (const pname in globalProducts) {
                const n = document.getElementById(pname + 'num');
                const comment = document.getElementById(pname + 'comment');
                if (n && n.value > 0) {
                    const s = {};
                    s['dpm'] = dpm;
                    s['name'] = pname;
                    s['price'] = parseInt(globalProducts[pname]);
                    s['num'] = parseInt(n.value);
                    s['comment'] = comment.value;
                    data.push(s);
                }
            }

            // 发送POST请求保存数据
            fetch('http://localhost:6060/add/sale/' + date, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(handleResult)
                .catch(handleError);
        } else {
            alert("请选择门店和日期");
        }
    });

    function downloadSubExcel() {
        const date = document.getElementById('choose_sale_date_for_download').value.trim();
        const dpm = document.getElementById('choose_dpm_name_for_download').value.trim();
        if (date && dpm && dpm !== 'NA') {
            downloadExcel(date, dpm);
        } else {
            alert("请选择日期和门店");
        }
    }

    function downloadAllSubExcel() {
        const date = document.getElementById('choose_sale_date_for_download').value.trim();
        const dpms = document.getElementById('choose_dpm_name_for_download').options;
        if (date) {
            for (var i = 0; i < dpms.length; i++) {
                downloadExcel(date, dpms[i].value);
            }
        } else {
            alert("请选择日期");
        }
    }

    function downloadTotalExcel() {
        const date = document.getElementById('choose_sale_date_for_download').value.trim();
        if (date) {
            downloadExcel(date, '');
        } else {
            alert("请选择日期");
        }
    }

    function downloadExcel(date, dpm) {
        let dpmt = 'NA';
        let file = '总表_' + date
        if (dpm && dpm !== dpmt) {
            dpmt = dpm;
            file = dpm + '_' + date
        }
        fetch('http://localhost:6060/download/' + date + '/' + dpmt)
            .then(response => {
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition ? contentDisposition.split('filename=')[1] : file + '.xlsx';
                return response.blob().then(blob => ({blob, filename}));
            })
            .then(({blob, filename}) => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(handleError);
    }

    function createSaleTable(dpm = '') {
        const dataTable = document.getElementById('dataTable');
        const tbody = dataTable.querySelector("tbody");
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        for (const name in globalProducts) {
            const price = globalProducts[name];
            const row = document.createElement("tr");
            const nameCell = document.createElement("td");
            const priceCell = document.createElement("td");
            const numCell = document.createElement("td");
            const commentCell = document.createElement("td");

            const numInput = document.createElement('input');
            numInput.type = 'number';
            numInput.name = 'num';
            numInput.value = 0;
            numInput.id = name + 'num';


            nameCell.textContent = name;
            // nameCell.setAttribute('name', 'pname');
            priceCell.textContent = price;
            // priceCell.setAttribute('name', 'price');

            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.name = 'comment';
            commentInput.id = name + 'comment';


            if (dpm && globalSales[dpm] && globalSales[dpm][name]) {
                numInput.value = globalSales[dpm][name]['num'];
                commentInput.value = globalSales[dpm][name]['comment'];
            }
            numCell.appendChild(numInput);
            // numCell.setAttribute('name', 'num');
            commentCell.appendChild(commentInput);
            // commentCell.setAttribute('name', 'comment');

            row.appendChild(nameCell);
            row.appendChild(priceCell);
            row.appendChild(numCell);
            row.appendChild(commentCell);
            tbody.appendChild(row);
        }
    }

    function createCheckTable(data) {
        const dataTable = document.getElementById('checkTable');
        const tbody = dataTable.querySelector("tbody");
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        for (const rowData of data) {
            const row = document.createElement("tr");
            for (const cellData of rowData) {
                const cell = document.createElement("td");
                cell.textContent = cellData;
                cell.style.width = '100px';
                row.appendChild(cell);
            }
            tbody.appendChild(row);
        }
    }

    function productPriceListening() {
        priceListening('update_product_name', 'update_product_price');
        priceListening('del_product_name', 'del_product_price');
    }

    function priceListening(nameId, priceId) {
        const name_elm = document.getElementById(nameId);
        name_elm.addEventListener("change", function () {
            const name = name_elm.value.trim();
            if (name && name !== 'NA') {
                const price_elm = document.getElementById(priceId);
                price_elm.value = globalProducts[name]
            }
        })
    }

    function fetchOptions(url, selector) {
        fetch(url).then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('请求失败');
            }
        }).then(data => {
            data = data.data;
            if (selector.startsWith('.')) {
                const selectElements = Array.from(document.querySelectorAll(selector));
                selectElements.forEach(selectElement => {
                    if (data.length === 0) {
                        // 如果返回的数据为空，则添加默认值"NA"
                        const optionElement = document.createElement('option');
                        optionElement.value = 'NA';
                        optionElement.textContent = 'NA';
                        selectElement.appendChild(optionElement);
                    } else {
                        data.forEach(option => {
                            if (typeof option === 'object' && !Array.isArray(option) && option !== null) {
                                option = option.name
                            }
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            selectElement.appendChild(optionElement);
                        });
                    }
                    selectElement.selectedIndex = -1;
                });
            }
            saveGlobal(data, selector)
        }).catch(error => {
            console.error('获取options失败', error);
            // 在请求失败时添加默认值"NA"
            const selectElement = document.querySelectorAll(selector);
            const optionElement = document.createElement('option');
            optionElement.value = 'NA';
            optionElement.textContent = 'NA';
            selectElement.appendChild(optionElement);
        });
    }

    function saveGlobal(data, type) {
        if (type.includes(".product")) {
            globalProducts = {};
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const name = item['name'];
                globalProducts[name] = item['price'];
            }
            createSaleTable();
        } else if (type.includes("globalSales")) {
            globalSales = {};
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const dpm = item['dpm'];
                globalSales[dpm] = globalSales[dpm] || {};
                globalSales[dpm][item['name']] = item;
            }

            const chooseDpmName = document.getElementById('choose_dpm_name');
            createSaleTable(chooseDpmName.value);
        }
    }

    function salesListening() {
        fetchOptions('http://localhost:6060/list/sale/' + getToday(), 'globalSales');

        const chooseDpmName = document.getElementById('choose_dpm_name');
        chooseDpmName.addEventListener("change", function () {
            createSaleTable(chooseDpmName.value)
        })

        const chooseSaleDate = document.getElementById('choose_sale_date');
        chooseSaleDate.addEventListener("change", function () {
            fetchOptions('http://localhost:6060/list/sale/' + chooseSaleDate.value, 'globalSales');
        })

        const clearSaleButton = document.getElementById('clearSaleButton');
        clearSaleButton.addEventListener('click', function () {
            createSaleTable();
        });
    }

    function handleResult(result) {
        console.log('请求成功', result);
        // 在此处可以添加成功保存后的处理逻辑
        const message = result.message;
        if (message) {
            window.alert(message); // 弹出提示框显示消息
        }
        location.reload(); // 刷新页面
    }

    function handleError(error) {
        if (error instanceof Response) {
            error.json().then(errorData => {
                const errorMessage = errorData && errorData.message ? errorData.message : '请求失败，请重试！';
                window.alert(errorMessage); // 弹出提示框
            });
        } else {
            // 其他错误，可能是网络连接问题等
            window.alert('请求失败，请检查网络连接！');
        }
    }

    function toggleDiv(divId, btnId, iconId) {
        const div = document.getElementById(divId);
        const btn = document.getElementById(btnId);
        const icon = document.getElementById(iconId);
        if (div.style.display === "none") {
            div.style.display = "block";
            btn.classList.add("expanded");
            icon.innerHTML = "v"; // 更改为向下箭头
        } else {
            div.style.display = "none";
            btn.classList.remove("expanded");
            icon.innerHTML = ">"; // 更改为原始箭头
        }
    }

    function defualtToday(ids) {
        var formattedDate = getToday();
        for (const id of ids) {
            document.getElementById(id).value = formattedDate;
        }
    }

    function getToday() {
        // 获取当前日期
        var currentDate = new Date();
        // 格式化日期
        var year = currentDate.getFullYear();
        var month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        var day = currentDate.getDate().toString().padStart(2, '0');
        return year + '-' + month + '-' + day;
    }


</script>
</body>
</html>
